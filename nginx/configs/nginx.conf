server {
    listen 80;
    listen [::]:80;
    server_name meysamaghili.ir git.meysamaghili.ir;
    access_log /var/log/nginx/access_custom.log;
    error_log /var/log/nginx/error_custom.log warn;
    return 301 https://$host$request_uri;
}

# server {
#     listen 443 ssl;
#     http2 on;
#     server_name meysamaghili.ir;

#     access_log /var/log/nginx/access_custom.log;
#     error_log /var/log/nginx/error_custom.log warn;

#     client_max_body_size 400M;

#     ssl_certificate     /etc/nginx/certs/resume.crt;
#     ssl_certificate_key /etc/nginx/certs/resume.key;

#     # Strong SSL settings
#     ssl_protocols TLSv1.2 TLSv1.3;
#     ssl_ciphers HIGH:!aNULL:!MD5;
#     ssl_prefer_server_ciphers on;
#     ssl_session_cache shared:SSL:10m;

#     # --- Gzip Compression ---
#     gzip on;
#     gzip_vary on;
#     gzip_min_length 1024;
#     gzip_proxied expired no-cache no-store private auth;
#     gzip_types
#         text/plain
#         text/css
#         text/xml
#         text/javascript
#         application/javascript
#         application/x-javascript
#         application/json
#         application/xml
#         application/xml+rss
#         image/svg+xml;

#     # --- Health Check Endpoint ---
#     location /health {
#         access_log off;
#         default_type text/plain;
#         return 200 "healthy\n";
#     }    

#     # --- Handle client-side routing (React Router) ---
#     # location / {
#     #     resolver 127.0.0.11 valid=30s;  # Docker DNS resolver
#     #     set $frontend_upstream http://178.131.8.158:3000;
#     #     proxy_pass $frontend_upstream;
#     #     proxy_http_version 1.1;
#     #     proxy_set_header Upgrade $http_upgrade;
#     #     proxy_set_header Connection 'upgrade';
#     #     proxy_set_header Host $host;
#     #     proxy_set_header X-Real-IP $remote_addr;
#     #     proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#     #     proxy_set_header X-Forwarded-Proto $scheme;
#     #     proxy_cache_bypass $http_upgrade;
#     #     log_subrequest on;
#     # }

#     # --- Docker Registry ---
#     location ~ ^/(v2|registry)/ {
#         access_log off;
#         resolver 127.0.0.11 valid=30s;
#         set $registry_upstream http://registry:5000;

#         # If /registry/, strip prefix
#         if ($request_uri ~ "^/registry/") {
#             rewrite ^/registry/(.*)$ /$1 break;
#         }

#         proxy_pass $registry_upstream;
#         proxy_http_version 1.1;
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Forwarded-Proto $scheme;
#         proxy_set_header Connection "";

#         # Crucial for Docker pushes
#         chunked_transfer_encoding on;
#         proxy_request_buffering off;
#         proxy_buffering off;

#         log_subrequest on;
#     }

#     # --- Airflow Web Server ---
#     location /projects/airflow/ {
#         resolver 127.0.0.11 valid=30s;
#         set $airflow_upstream http://airflow:1000;
#         proxy_pass $airflow_upstream;
#         proxy_http_version 1.1;
#         proxy_set_header Upgrade $http_upgrade;
#         proxy_set_header Connection 'upgrade';
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Forwarded-Proto $scheme;
#         proxy_set_header X-Forwarded-Host $host;
#         proxy_set_header X-Forwarded-Server $host;
#         proxy_cache_bypass $http_upgrade;
#         log_subrequest on;
#     }

#     # --- Security Headers ---
#     add_header X-Frame-Options "SAMEORIGIN" always;
#     add_header X-Content-Type-Options "nosniff" always;
#     add_header X-XSS-Protection "1; mode=block" always;
#     add_header Referrer-Policy "strict-origin-when-cross-origin" always;
#     add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;
# }

server {
    listen 443 ssl;
    http2 on;
    server_name git.meysamaghili.ir;

    access_log /var/log/nginx/git_access.log;
    error_log /var/log/nginx/git_error.log warn;

    # Adjust based on your Git service needs
    client_max_body_size 100M;

    ssl_certificate     /etc/nginx/certs/git.crt;
    ssl_certificate_key /etc/nginx/certs/git.key;

    # Strong SSL settings
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;
    ssl_session_cache shared:SSL:10m;

    # --- Gzip Compression ---
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_proxied expired no-cache no-store private auth;
    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/javascript
        application/x-javascript
        application/json
        application/xml
        application/xml+rss
        image/svg+xml;

    # --- Git Service Configuration ---
    # Example for Gitea/GitLab/Git service
    location / {
        # resolver 127.0.0.11 valid=30s;
        # Change this to your Git service's address and port
        set $git_upstream http://127.0.0.1:3000;
        
        proxy_pass $git_upstream;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Server $host;
        proxy_cache_bypass $http_upgrade;
        
        # Important for Git push/pull operations
        proxy_request_buffering off;
        proxy_buffering off;
    }

    # --- Security Headers ---
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;
}
